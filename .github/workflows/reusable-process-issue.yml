name: ğŸ”„ Issueå‡¦ç†ï¼ˆå…±é€šãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰

on:
  workflow_call:
    inputs:
      issue-type:
        description: 'å‡¦ç†ã‚¿ã‚¤ãƒ—ï¼ˆadd: æ–°è¦è¿½åŠ , extend: ãƒãƒ†ãƒªã‚¢ãƒ«æ‹¡å¼µï¼‰'
        required: true
        type: string
      issue-body:
        description: 'Issueæœ¬æ–‡ï¼ˆãƒ‘ãƒ¼ã‚¹ç”¨ï¼‰'
        required: true
        type: string
      issue-number:
        description: 'Issueç•ªå·'
        required: true
        type: string
      actor:
        description: 'Issueä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å'
        required: true
        type: string
      actor-id:
        description: 'Issueä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID'
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  process:
    name: ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’å‡¦ç†
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5

      - name: ğŸ¦€ Rustã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: ğŸ”¨ CLIãƒ„ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰
        run: cargo build --release

      - name: âš™ï¸ Issueã‚’å‡¦ç†ã—ã¦ãƒ¢ãƒ‡ãƒ«ã‚’ç”Ÿæˆ
        id: process
        run: |
          # Issueæœ¬æ–‡ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦èª­ã¿è¾¼ã¿
          ISSUE_BODY=$(cat << 'ISSUE_EOF'
          ${{ inputs.issue-body }}
          ISSUE_EOF
          )

          # CLIãƒ„ãƒ¼ãƒ«ã§Issueã‚’å‡¦ç†ï¼ˆç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ¢ãƒ‡ãƒ«ç”Ÿæˆï¼‰
          OUTPUT=$(GITHUB_TOKEN=${{ secrets.token }} ./target/release/processor runner process-issue \
            --issue-type ${{ inputs.issue-type }} \
            --issue-number ${{ inputs.issue-number }} \
            --body "$ISSUE_BODY" 2>&1)

          EXIT_CODE=$?

          # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ã—ã¦çµ‚äº†
          if [ $EXIT_CODE -ne 0 ]; then
            echo "error_occurred=true" >> $GITHUB_OUTPUT
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo "$OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi

          set -euo pipefail

          # CLIãƒ„ãƒ¼ãƒ«ã®å‡ºåŠ›ã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡º
          CUSTOM_MODEL_DATA=$(echo "$OUTPUT" | grep "^CUSTOM_MODEL_DATA=" | cut -d= -f2-)
          echo "custom_model_data=$CUSTOM_MODEL_DATA" >> $GITHUB_OUTPUT

          # æ–°è¦è¿½åŠ ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒURLã‚‚å–å¾—
          if [ "${{ inputs.issue-type }}" = "add" ]; then
            PREVIEW_URL=$(echo "$OUTPUT" | grep "^PREVIEW_URL=" | cut -d= -f2-)
            echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ã‚’æº–å‚™ï¼ˆæ–°è¦è¿½åŠ ï¼‰
        if: inputs.issue-type == 'add'
        id: pr_details_add
        run: |
          echo "commit_message=âœ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ : ${{ steps.process.outputs.custom_model_data }} (#${{ inputs.issue-number }})" >> $GITHUB_OUTPUT
          echo "title=âœ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ : ${{ steps.process.outputs.custom_model_data }}" >> $GITHUB_OUTPUT
          BODY=$(cat <<EOF
          ## ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ

          Resolves #${{ inputs.issue-number }}

          ### ğŸ“¸ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒï¼ˆ256Ã—256ã€ãƒ”ã‚¯ã‚»ãƒ«ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆæ‹¡å¤§ï¼‰

          ![${{ steps.process.outputs.custom_model_data }}](${{ steps.process.outputs.preview_url }})

          ---

          ### â„¹ï¸ è‡ªå‹•ç”Ÿæˆã®å†…å®¹

          - âœ… ãƒ†ã‚¯ã‚¹ãƒãƒ£ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ\`assets/minecraft/textures/item/${{ steps.process.outputs.custom_model_data }}.png\`ï¼‰
          - âœ… ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆ\`assets/minecraft/models/item/${{ steps.process.outputs.custom_model_data }}.json\`ï¼‰
          - âœ… å„ãƒãƒ†ãƒªã‚¢ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è¨­å®š

          ---

          *ğŸ¤– ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF
          )
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸ“ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å†…å®¹ã‚’æº–å‚™ï¼ˆãƒãƒ†ãƒªã‚¢ãƒ«æ‹¡å¼µï¼‰
        if: inputs.issue-type == 'extend'
        id: pr_details_extend
        run: |
          echo "commit_message=ğŸ”§ ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’æ‹¡å¼µ: ${{ steps.process.outputs.custom_model_data }} (#${{ inputs.issue-number }})" >> $GITHUB_OUTPUT
          echo "title=ğŸ”§ æ—¢å­˜ãƒ¢ãƒ‡ãƒ«ã«ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’è¿½åŠ : ${{ steps.process.outputs.custom_model_data }}" >> $GITHUB_OUTPUT
          BODY=$(cat <<EOF
          ## ğŸ”§ æ—¢å­˜ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã«ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ

          Resolves #${{ inputs.issue-number }}

          ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ« \`${{ steps.process.outputs.custom_model_data }}\` ã«æ–°ã—ã„ãƒãƒ†ãƒªã‚¢ãƒ«ã‚’è¿½åŠ ã—ã€ã‚¢ã‚¤ãƒ†ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚

          ---

          ### â„¹ï¸ å¤‰æ›´å†…å®¹

          - âœ… æ–°ã—ã„ãƒãƒ†ãƒªã‚¢ãƒ«ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰è¨­å®šã‚’è¿½åŠ 
          - âœ… æ—¢å­˜ã®ãƒ¢ãƒ‡ãƒ«ã¨ãƒ†ã‚¯ã‚¹ãƒãƒ£ã¯ãã®ã¾ã¾åˆ©ç”¨

          ---

          *ğŸ¤– ã“ã®ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯ GitHub Actions ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*
          EOF
          )
          echo "body<<EOF" >> $GITHUB_OUTPUT
          echo "$BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ğŸš€ ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ä½œæˆ
        id: create_pr
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.token }}
          commit-message: ${{ steps.pr_details_add.outputs.commit_message || steps.pr_details_extend.outputs.commit_message }}
          title: ${{ steps.pr_details_add.outputs.title || steps.pr_details_extend.outputs.title }}
          body: ${{ steps.pr_details_add.outputs.body || steps.pr_details_extend.outputs.body }}
          branch: ${{ inputs.issue-type }}-model/issue-${{ inputs.issue-number }}
          delete-branch: true
          committer: GitHub Actions Bot <actions@github.com>
          author: ${{ inputs.actor }} <${{ inputs.actor-id }}+${{ inputs.actor }}@users.noreply.github.com>

      - name: âœ… Issueã«æˆåŠŸã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ï¼ˆæ–°è¦è¿½åŠ ï¼‰
        if: steps.create_pr.outputs.pull-request-number && inputs.issue-type == 'add'
        run: |
          GITHUB_TOKEN=${{ secrets.token }} ./target/release/processor runner post-success \
            --issue-number ${{ inputs.issue-number }} \
            --pr-number ${{ steps.create_pr.outputs.pull-request-number }} \
            --preview-url "${{ steps.process.outputs.preview_url }}"

      - name: âœ… Issueã«æˆåŠŸã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ï¼ˆãƒãƒ†ãƒªã‚¢ãƒ«æ‹¡å¼µï¼‰
        if: steps.create_pr.outputs.pull-request-number && inputs.issue-type == 'extend'
        run: |
          GITHUB_TOKEN=${{ secrets.token }} ./target/release/processor runner post-extend-success \
            --issue-number ${{ inputs.issue-number }} \
            --pr-number ${{ steps.create_pr.outputs.pull-request-number }}

      - name: âŒ Issueã«ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        if: failure()
        run: |
          ERROR_MSG="${{ steps.process.outputs.error_message }}"
          if [ -z "$ERROR_MSG" ]; then
            ERROR_MSG="å‡¦ç†ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi

          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          GITHUB_TOKEN=${{ secrets.token }} ./target/release/processor runner post-failure \
            --issue-number ${{ inputs.issue-number }} \
            --error-message "$ERROR_MSG" \
            --workflow-url "$WORKFLOW_URL"
