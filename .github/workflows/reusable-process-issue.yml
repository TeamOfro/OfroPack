name: ğŸ”„ Issueå‡¦ç†ï¼ˆå…±é€šãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼‰

on:
  workflow_call:
    inputs:
      issue-type:
        description: 'å‡¦ç†ã‚¿ã‚¤ãƒ—ï¼ˆmodel: 2Dãƒ¢ãƒ‡ãƒ«è¿½åŠ , model3d: 3Dãƒ¢ãƒ‡ãƒ«è¿½åŠ , extend: ãƒãƒ†ãƒªã‚¢ãƒ«æ‹¡å¼µï¼‰'
        required: true
        type: string
      issue-body:
        description: 'Issueæœ¬æ–‡ï¼ˆãƒ‘ãƒ¼ã‚¹ç”¨ï¼‰'
        required: true
        type: string
      issue-number:
        description: 'Issueç•ªå·'
        required: true
        type: string
      actor:
        description: 'Issueä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å'
        required: true
        type: string
      actor-id:
        description: 'Issueä½œæˆè€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID'
        required: true
        type: string
    secrets:
      token:
        required: true

jobs:
  process:
    name: ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’å‡¦ç†
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v5

      - name: ğŸ¦€ Rustã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: ğŸ”¨ CLIãƒ„ãƒ¼ãƒ«ã‚’ãƒ“ãƒ«ãƒ‰
        run: cargo build --release

      - name: âš™ï¸  Issueã‚’å‡¦ç†ï¼ˆãƒ¢ãƒ‡ãƒ«ç”Ÿæˆã€PRä½œæˆã€ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼‰
        id: process
        env:
          GITHUB_TOKEN: ${{ secrets.token }}
          PR_BRANCH: ${{ inputs.issue-type }}/issue-${{ inputs.issue-number }}
        run: |
          # Issueæœ¬æ–‡ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦èª­ã¿è¾¼ã¿
          ISSUE_BODY=$(cat << 'ISSUE_EOF'
          ${{ inputs.issue-body }}
          ISSUE_EOF
          )

          # CLIãƒ„ãƒ¼ãƒ«ã§Issueã‚’å‡¦ç†ï¼ˆç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ¢ãƒ‡ãƒ«ç”Ÿæˆã€PRä½œæˆã€æˆåŠŸã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ï¼‰
          OUTPUT=$(./target/release/processor runner process-issue \
            --issue-type ${{ inputs.issue-type }} \
            --issue-number ${{ inputs.issue-number }} \
            --body "$ISSUE_BODY" \
            --actor "${{ inputs.actor }}" \
            --actor-email "${{ inputs.actor-id }}+${{ inputs.actor }}@users.noreply.github.com" 2>&1)

          EXIT_CODE=$?

          # ã‚¨ãƒ©ãƒ¼æ™‚ã¯ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä¿å­˜ã—ã¦çµ‚äº†
          if [ $EXIT_CODE -ne 0 ]; then
            echo "error_message=$(echo "$OUTPUT" | tail -n +1)" >> $GITHUB_OUTPUT
            exit $EXIT_CODE
          fi

      - name: âŒ Issueã«ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        if: failure() && steps.process.conclusion == 'failure'
        env:
          GITHUB_TOKEN: ${{ secrets.token }}
        run: |
          ERROR_MSG="${{ steps.process.outputs.error_message }}"
          if [ -z "$ERROR_MSG" ]; then
            ERROR_MSG="å‡¦ç†ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          fi

          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          ./target/release/processor runner post-failure \
            --issue-number ${{ inputs.issue-number }} \
            --error-message "$ERROR_MSG" \
            --workflow-url "$WORKFLOW_URL"
