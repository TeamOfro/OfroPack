name: Add Custom Model from Issue

on:
  issues:
    types: [opened]

env:
  ISSUE_NUMBER: ${{ github.event.issue.number }}
  REPO_OWNER: ${{ github.repository_owner }}
  REPO_NAME: ${{ github.event.repository.name }}
  PR_BRANCH: custom-model/issue-${{ github.event.issue.number }}

jobs:
  parse-and-add:
    if: contains(github.event.issue.labels.*.name, 'custom-model')
    runs-on: ubuntu-22.04
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Build processor tool
        run: cargo build --release

      - name: Process issue
        id: process
        run: |
          set -euo pipefail
          
          ISSUE_BODY=$(cat << 'ISSUE_EOF'
          ${{ github.event.issue.body }}
          ISSUE_EOF
          )
          
          # Process entire issue (download, validate, add model, generate preview)
          OUTPUT=$(./target/release/processor runner process-issue \
            --issue-number ${{ env.ISSUE_NUMBER }} \
            --body "$ISSUE_BODY" 2>&1)
          
          EXIT_CODE=$?
          
          if [ $EXIT_CODE -ne 0 ]; then
            echo "error_occurred=true" >> $GITHUB_OUTPUT
            echo "error_message<<EOF" >> $GITHUB_OUTPUT
            echo "$OUTPUT" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          # Extract preview URL and custom model data from output
          PREVIEW_URL=$(echo "$OUTPUT" | grep "^PREVIEW_URL=" | cut -d= -f2-)
          CUSTOM_MODEL_DATA=$(echo "$OUTPUT" | grep "^CUSTOM_MODEL_DATA=" | cut -d= -f2-)
          
          echo "preview_url=$PREVIEW_URL" >> $GITHUB_OUTPUT
          echo "custom_model_data=$CUSTOM_MODEL_DATA" >> $GITHUB_OUTPUT
          
          echo "âœ“ Issueå‡¦ç†å®Œäº†"

      - name: Create Pull Request
        id: create_pr
        if: success()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ : ${{ steps.process.outputs.custom_model_data }} (#${{ env.ISSUE_NUMBER }})"
          title: "âœ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ : ${{ steps.process.outputs.custom_model_data }}"
          body: |
            ## ğŸ¨ ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ‡ãƒ«ãƒ‡ãƒ¼ã‚¿ã®è¿½åŠ 

            Resolves #${{ env.ISSUE_NUMBER }}

            ### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆ256Ã—256ã€ãƒ”ã‚¯ã‚»ãƒ«ãƒ‘ãƒ¼ãƒ•ã‚§ã‚¯ãƒˆï¼‰

            ![${{ steps.process.outputs.custom_model_data }}](${{ steps.process.outputs.preview_url }})

            ---

            *ã“ã®PRã¯GitHub Actionsã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*
          branch: ${{ env.PR_BRANCH }}
          delete-branch: true
          committer: GitHub Actions Bot <actions@github.com>
          author: ${{ github.actor }} <${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com>

      - name: Post success comment
        if: steps.create_pr.outputs.pull-request-number
        run: |
          ./target/release/processor runner post-success \
            --issue-number ${{ env.ISSUE_NUMBER }} \
            --pr-number ${{ steps.create_pr.outputs.pull-request-number }} \
            --preview-url "${{ steps.process.outputs.preview_url }}"

      - name: Post failure comment
        if: failure()
        run: |
          ERROR_MSG="${{ steps.process.outputs.error_message }}"
          if [ -z "$ERROR_MSG" ]; then
            ERROR_MSG="å‡¦ç†ä¸­ã«äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
          fi
          
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          ./target/release/processor runner post-failure \
            --issue-number ${{ env.ISSUE_NUMBER }} \
            --error-message "$ERROR_MSG" \
            --workflow-url "$WORKFLOW_URL"
